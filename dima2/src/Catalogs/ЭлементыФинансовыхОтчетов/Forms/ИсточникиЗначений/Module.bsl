
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Перем Кэш;
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;
	
	Заполнение = Ложь;
	Если Параметры.Свойство("Заполнение") Тогда
		Заполнение = Параметры.Заполнение;
	КонецЕсли;
	
	ДеревоЭлементов = ПолучитьИзВременногоХранилища(Параметры.АдресЭлементовОтчета);
	СтрокаДерева = ФинансоваяОтчетностьКлиентСервер.ПодчиненныйЭлемент(ДеревоЭлементов, "АдресСтруктурыЭлемента", Параметры.АдресЭлементаВХранилище);
	СписокДоступныхЭлементов = БюджетнаяОтчетностьРасчетКэшаСервер.ИсточникиЗначенийЭлемента(СтрокаДерева, Кэш, Заполнение);
	
	ТаблицаПредыдущихИсточников = Параметры.ИсточникиЗначений.Выгрузить(Новый Структура("ДобавляемыеЗначенияДокумента", Ложь));
	ДеревоИсточников = ДанныеФормыВЗначение(ИсточникиЗначений, Тип("ДеревоЗначений"));
	
	НоваяСтрока = Неопределено;
	Для Каждого СтрокаДоступныхЭлементов из СписокДоступныхЭлементов Цикл
		Элемент = СтрокаДоступныхЭлементов.Элемент;
		Если ЗначениеЗаполнено(СтрокаДоступныхЭлементов.Родитель) Тогда
			МестоДобавления = ДеревоИсточников.Строки.Найти(СтрокаДоступныхЭлементов.Родитель, "Источник", Истина);
		Иначе
			МестоДобавления = ДеревоИсточников;
		КонецЕсли;
		НоваяСтрока = МестоДобавления.Строки.Добавить();
		НоваяСтрока.Источник = Элемент;
		Если ТипЗнч(Элемент) = Тип("Строка") Тогда
			РеквизитыОбъекта = ПолучитьИзВременногоХранилища(Элемент);
		Иначе
			РеквизитыОбъекта = Новый Структура("Ссылка", Элемент);
		КонецЕсли;
		НоваяСтрока.ВидЭлемента = СтрокаДоступныхЭлементов.ВидЭлемента;
		НоваяСтрока.Представление = СтрокаДоступныхЭлементов.Наименование;
		НоваяСтрока.НестандартнаяКартинка = ФинансоваяОтчетностьПовтИсп.НестандартнаяКартинка(НоваяСтрока.ВидЭлемента);
		Для Каждого СтрокаЭлемента из ТаблицаПредыдущихИсточников Цикл
			Если СтрокаЭлемента.Источник = РеквизитыОбъекта.Ссылка ИЛИ СтрокаЭлемента.Источник = Элемент Тогда
				НоваяСтрока.Использование = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
	КонецЦикла;
	
	ЗаполнитьФлагиПоПодчиненнымЭлементам(ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(ДеревоИсточников));
	
	ЗначениеВРеквизитФормы(ДеревоИсточников, "ИсточникиЗначений");
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ПодчиненныеСтроки = ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(ИсточникиЗначений);
	Для Каждого ПодчиненнаяСтрока из ПодчиненныеСтроки Цикл
		Элементы.ИсточникиЗначений.Развернуть(ПодчиненнаяСтрока.ПолучитьИдентификатор(), Истина);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийТаблицыФормы

&НаКлиенте
Процедура ИсточникиЗначенийИспользованиеПриИзменении(Элемент)
	
	ТекущиеДанные = Элементы.ИсточникиЗначений.ТекущиеДанные;
	Если ТекущиеДанные.Использование = 2 Тогда
		ТекущиеДанные.Использование = 0;
	КонецЕсли;
	
	ЗаполнитьФлагиПодчиненныхСтрок(ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(ТекущиеДанные), ТекущиеДанные.Использование);
	
	Родитель = ФинансоваяОтчетностьКлиентСервер.РодительСтроки(ТекущиеДанные);
	Пока Родитель <> Неопределено Цикл
		ПодчиненныеСтроки = ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(Родитель);
		Родитель.Использование = ЗаполнитьФлагиПоПодчиненнымЭлементам(ПодчиненныеСтроки, Ложь);
		Родитель = ФинансоваяОтчетностьКлиентСервер.РодительСтроки(Родитель);
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура Выбрать(Команда)
	
	Закрыть(ПолучитьРезультатВыбора());
	
КонецПроцедуры

&НаКлиенте
Процедура ОтметитьВсе(Команда)
	
	ЗаполнитьФлагиПодчиненныхСтрок(ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(ИсточникиЗначений), 1);
	
КонецПроцедуры

&НаКлиенте
Процедура СнятьВсе(Команда)
	
	ЗаполнитьФлагиПодчиненныхСтрок(ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(ИсточникиЗначений), 0);
	
КонецПроцедуры

&НаКлиенте
Процедура РазвернутьВсе(Команда)

	ПодчиненныеСтроки = ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(ИсточникиЗначений);
	Для Каждого ПодчиненнаяСтрока из ПодчиненныеСтроки Цикл
		Элементы.ИсточникиЗначений.Развернуть(ПодчиненнаяСтрока.ПолучитьИдентификатор(), Истина);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура СвернутьВсе(Команда)

	ПодчиненныеСтроки = ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(ИсточникиЗначений);
	СвернутьСтроку(ПодчиненныеСтроки);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ЗаполнитьФлагиПодчиненныхСтрок(Строки, Флаг)
	
	Для Каждого Строка из Строки Цикл
		Строка.Использование = Флаг;
		ПодчиненныеСтроки = ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(Строка);
		ЗаполнитьФлагиПодчиненныхСтрок(ПодчиненныеСтроки, Флаг);
	КонецЦикла;
	
КонецПроцедуры

&НаСервере
Функция ПолучитьРезультатВыбора()
	
	Результат = Новый Массив;
	НайденныеСтроки = РеквизитФормыВЗначение("ИсточникиЗначений").Строки.НайтиСтроки(Новый Структура("Использование", 1), Истина);
	МассивДоступныхВидов = Новый Массив;
	МассивДоступныхВидов.Добавить(Перечисления.ВидыЭлементовФинансовогоОтчета.СтатьяБюджетов);
	МассивДоступныхВидов.Добавить(Перечисления.ВидыЭлементовФинансовогоОтчета.ПоказательБюджетов);
	МассивДоступныхВидов.Добавить(Перечисления.ВидыЭлементовФинансовогоОтчета.НефинансовыйПоказатель);
	
	Для Каждого НайденнаяСтрока из НайденныеСтроки Цикл
		Если НайденнаяСтрока.Строки.Количество() Тогда
			//Источники расположены на "нижнем" уровне дерева
			Продолжить;
		КонецЕсли;
		Если МассивДоступныхВидов.Найти(НайденнаяСтрока.ВидЭлемента) = Неопределено Тогда
			Продолжить;
		КонецЕсли;
		Результат.Добавить(НайденнаяСтрока.Источник);
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

&НаКлиентеНаСервереБезКонтекста
Функция ЗаполнитьФлагиПоПодчиненнымЭлементам(СтрокиДерева, ВключаяПодчиненные = Истина)
	
	МассивФлаговТекущегоУровня = Новый Массив;
	Для Каждого Строка из СтрокиДерева Цикл
		
		Если ВключаяПодчиненные Тогда
			ПодчиненныеСтроки = ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(Строка);
		КонецЕсли;
		Если ВключаяПодчиненные И ПодчиненныеСтроки.Количество() Тогда
			Строка.Использование = ЗаполнитьФлагиПоПодчиненнымЭлементам(ПодчиненныеСтроки);
		КонецЕсли;
		МассивФлаговТекущегоУровня.Добавить(Строка.Использование);
		
	КонецЦикла;
	
	Результат = ОбщегоНазначенияКлиентСервер.СвернутьМассив(МассивФлаговТекущегоУровня);
	Если Результат.Количество() = 2 Тогда
		Возврат 2;
	ИначеЕсли Результат.Количество() Тогда
		Возврат Результат[0];
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Процедура СвернутьСтроку(СтрокиДерева)
	
	Для Каждого Строка из СтрокиДерева Цикл
		ПодчиненныеСтроки = ФинансоваяОтчетностьКлиентСервер.ПодчиненныеСтроки(Строка);
		СвернутьСтроку(ПодчиненныеСтроки);
		Элементы.ИсточникиЗначений.Свернуть(Строка.ПолучитьИдентификатор());
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти
