
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Если Параметры.Свойство("АвтоТест") Тогда // Возврат при получении формы для анализа.
		Возврат;
	КонецЕсли;

	Заголовок = Параметры.Фамилия + " " + Параметры.Имя + " " + Параметры.Отчество;
	
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура КодПоДРФОПриИзменении(Элемент)	
	
	СообщенияПроверки = "";
	
	Если НЕ ПустаяСтрока(КодПоДРФО) Тогда	
		
		Если РегламентированныеДанныеКлиентСервер.КодПоЕДРПОУСоответствуетТребованиям(КодПоДРФО, Ложь, СообщенияПроверки) Тогда	
		
			Если ИдентификаторФизическогоЛицаУникален("КодПоДРФО", КодПоДРФО) Тогда	
			
				ПоКодПоДРФОПроверкаПройдена = Истина;
				
				ПроверкаПройдена();
		
			Иначе
			
				ПоКодПоДРФОПроверкаПройдена = Ложь;
				
				КодПоДРФОКартинка = БиблиотекаКартинок.ПротоколСОшибкой;
			
				СообщенияПроверки = НСтр("ru='Найден человек с таким же кодом по ДРФО (ИНН). Обратитесь к администратору информационной системы для устранения проблемы.';uk='Знайдена людина з таким же кодом за ДРФО (ІПН). Зверніться до адміністратора інформаційної системи для усунення проблеми.'");
				
				
			КонецЕсли;
			
		Иначе
		
			ПоКодПоДРФОПроверкаПройдена = Ложь;
				
			КодПоДРФОКартинка = БиблиотекаКартинок.Предупреждение;
			
		КонецЕсли;
		
	Иначе
		
		КодПоДРФОКартинка = Новый Картинка;
		
				
	КонецЕсли;
	
	Элементы.КодПоДРФО.Подсказка = СообщенияПроверки;
	Элементы.КодПоДРФОКартинка.Подсказка = СообщенияПроверки;
	
КонецПроцедуры




#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаКлиенте
Процедура ПроверкаПройдена()
	
	Если ПоКодПоДРФОПроверкаПройдена Тогда	
		
		СтруктураВозврата = Новый Структура();
		
		Если ПоКодПоДРФОПроверкаПройдена Тогда
			СтруктураВозврата.Вставить("КодПоДРФО", КодПоДРФО);
		КонецЕсли; 
		
		
		Закрыть(СтруктураВозврата);
		
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция ИдентификаторФизическогоЛицаУникален(Идентификатор, ЗначениеИдентификатора)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ФизическиеЛица.Ссылка КАК Ссылка
	|ИЗ
	|	Справочник.ФизическиеЛица КАК ФизическиеЛица
	|ГДЕ
	|	ФизическиеЛица.КодПоДРФО = &ЗначениеИдентификатора";
	
	Запрос.Текст = СтрЗаменить(Запрос.Текст, ".КодПоДРФО", "." + Идентификатор);
	
	Запрос.УстановитьПараметр("ЗначениеИдентификатора", ЗначениеИдентификатора);
	
	УстановитьПривилегированныйРежим(Истина);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	УстановитьПривилегированныйРежим(Ложь);
	
	Возврат РезультатЗапроса.Пустой();
	
КонецФункции


#КонецОбласти
